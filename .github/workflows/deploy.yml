name: Deploy MyClaw

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'nixos/**'
      - 'src/**'
      - 'runtime/**'
      - 'flake.nix'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Deployment mode'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick       # Fast: nixos-rebuild + update app (~2 min)
          - full        # Full: destroy & recreate everything (~15 min)

env:
  TF_VERSION: '1.6.0'
  TF_VAR_hcloud_token: ${{ secrets.HETZNER_API_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_allowed_ssh_ip: ${{ secrets.ALLOWED_SSH_IP }}

jobs:
  # Determine deployment mode
  check:
    name: Check Server Status
    runs-on: ubuntu-latest
    outputs:
      server_exists: ${{ steps.check.outputs.exists }}
      server_ip: ${{ steps.check.outputs.ip }}
      firewall_id: ${{ steps.check.outputs.firewall_id }}
      deploy_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Check if Server Exists
        id: check
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          SERVER_IP=$(hcloud server ip myclaw 2>/dev/null || echo "")
          if [ -n "$SERVER_IP" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ip=$SERVER_IP" >> $GITHUB_OUTPUT
            FIREWALL_ID=$(hcloud firewall describe myclaw -o json 2>/dev/null | jq -r '.id' || echo "")
            echo "firewall_id=$FIREWALL_ID" >> $GITHUB_OUTPUT
            echo "Server found at $SERVER_IP"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ip=" >> $GITHUB_OUTPUT
            echo "firewall_id=" >> $GITHUB_OUTPUT
            echo "No server found"
          fi

      - name: Determine Deploy Mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.deploy_mode }}"
          elif [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            MODE="quick"
          else
            MODE="full"
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "Deploy mode: $MODE"

  # Quick deploy: update NixOS config + app code
  quick-deploy:
    name: Quick Deploy
    needs: check
    runs-on: ubuntu-latest
    if: needs.check.outputs.deploy_mode == 'quick' && needs.check.outputs.server_exists == 'true'
    outputs:
      server_ip: ${{ needs.check.outputs.server_ip }}
      firewall_id: ${{ needs.check.outputs.firewall_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Allow GitHub Runner SSH Access
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "GitHub Runner IP: $RUNNER_IP"
          hcloud firewall add-rule ${{ needs.check.outputs.firewall_id }} \
            --direction in \
            --protocol tcp \
            --port 22 \
            --source-ips "$RUNNER_IP/32" \
            --description "Temporary: GitHub Actions quick deploy" || true
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV

      - name: Inject SSH Key into NixOS Config
        run: |
          sed -i 's|openssh.authorizedKeys.keys = \[|openssh.authorizedKeys.keys = [ "'"${{ secrets.SSH_PUBLIC_KEY }}"'" |' nixos/configuration.nix

      - name: Update NixOS Configuration
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ needs.check.outputs.server_ip }}"

          echo "Copying NixOS configuration..."
          ssh $SSH_OPTS root@$SERVER_IP "mkdir -p /etc/nixos/nixos"
          scp $SSH_OPTS flake.nix root@$SERVER_IP:/etc/nixos/
          scp $SSH_OPTS -r nixos/* root@$SERVER_IP:/etc/nixos/nixos/

          echo "Running nixos-rebuild switch..."
          ssh $SSH_OPTS root@$SERVER_IP "cd /etc/nixos && nixos-rebuild switch --flake .#myclaw"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build Application
        run: |
          npm ci
          npx tsc

      - name: Deploy Application
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ needs.check.outputs.server_ip }}"

          echo "Deploying application files..."
          ssh $SSH_OPTS root@$SERVER_IP "mkdir -p /var/lib/myclaw/app/runtime/.claude"

          # Copy built application
          scp $SSH_OPTS -r dist root@$SERVER_IP:/var/lib/myclaw/app/
          scp $SSH_OPTS package.json package-lock.json root@$SERVER_IP:/var/lib/myclaw/app/
          scp $SSH_OPTS -r runtime root@$SERVER_IP:/var/lib/myclaw/app/

          # Install production dependencies on server (compiles native modules for Linux)
          echo "Installing production dependencies..."
          ssh $SSH_OPTS root@$SERVER_IP "cd /var/lib/myclaw/app && npm ci --production"

          # Install Claude Code CLI globally
          echo "Installing Claude Code CLI..."
          ssh $SSH_OPTS root@$SERVER_IP "npm install -g @anthropic-ai/claude-code"

          # Fix ownership
          ssh $SSH_OPTS root@$SERVER_IP "chown -R myclaw:myclaw /var/lib/myclaw/app"

      - name: Deploy Environment File
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ needs.check.outputs.server_ip }}"

          # Assemble .env from individual secrets
          cat > /tmp/myclaw.env << ENVEOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ALLOWED_IDS=${{ secrets.TELEGRAM_ALLOWED_IDS }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET }}
          VAULT_PATH=/var/lib/myclaw/vault
          DB_PATH=/var/lib/myclaw/data/myclaw.db
          NODE_ENV=production
          ACTIVE_HOURS_START=08:00
          ACTIVE_HOURS_END=22:00
          ACTIVE_HOURS_TZ=Europe/Paris
          HEARTBEAT_INTERVAL_CRON=*/30 * * * *
          CLAUDE_MODEL=claude-sonnet-4-5-20250929
          HEARTBEAT_MODEL=claude-haiku-4-5-20251001
          ENVEOF

          scp $SSH_OPTS /tmp/myclaw.env root@$SERVER_IP:/var/lib/myclaw/.env
          ssh $SSH_OPTS root@$SERVER_IP "chown myclaw:myclaw /var/lib/myclaw/.env && chmod 600 /var/lib/myclaw/.env"
          rm -f /tmp/myclaw.env

      - name: Deploy rclone Config
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ needs.check.outputs.server_ip }}"

          if [ -n "${{ secrets.RCLONE_CONFIG }}" ]; then
            echo "Deploying rclone configuration..."
            ssh $SSH_OPTS root@$SERVER_IP "mkdir -p /var/lib/myclaw/.config/rclone"
            printf '%s' "${{ secrets.RCLONE_CONFIG }}" > /tmp/rclone.conf
            scp $SSH_OPTS /tmp/rclone.conf root@$SERVER_IP:/var/lib/myclaw/.config/rclone/rclone.conf
            ssh $SSH_OPTS root@$SERVER_IP "chown -R myclaw:myclaw /var/lib/myclaw/.config && chmod 600 /var/lib/myclaw/.config/rclone/rclone.conf"
            rm -f /tmp/rclone.conf
          fi

      - name: Restart MyClaw Service
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          ssh $SSH_OPTS root@${{ needs.check.outputs.server_ip }} "systemctl restart myclaw"
          echo "MyClaw service restarted"

      - name: Remove Temporary Firewall Rule
        if: always()
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          if [ -n "$RUNNER_IP" ]; then
            hcloud firewall delete-rule ${{ needs.check.outputs.firewall_id }} \
              --direction in \
              --protocol tcp \
              --port 22 \
              --source-ips "$RUNNER_IP/32" || true
          fi

      - name: Deploy Summary
        run: |
          echo "## Quick Deploy Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server IP:** \`${{ needs.check.outputs.server_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SSH:** \`ssh root@${{ needs.check.outputs.server_ip }}\`" >> $GITHUB_STEP_SUMMARY

  # Full deploy: create infrastructure + install NixOS + deploy app
  validate:
    name: Validate Configuration
    needs: check
    runs-on: ubuntu-latest
    if: needs.check.outputs.deploy_mode == 'full' || needs.check.outputs.server_exists == 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        working-directory: terraform
        run: tofu fmt -check -recursive

      - name: Terraform Init
        working-directory: terraform
        run: tofu init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: tofu validate

  plan:
    name: Plan Infrastructure
    needs: [check, validate]
    runs-on: ubuntu-latest
    if: needs.check.outputs.deploy_mode == 'full' || needs.check.outputs.server_exists == 'false'
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TF_VERSION }}

      - name: Restore Terraform State
        uses: actions/cache/restore@v4
        with:
          path: |
            terraform/terraform.tfstate
            terraform/terraform.tfstate.backup
          key: terraform-state-${{ github.repository }}

      - name: Terraform Init
        working-directory: terraform
        run: tofu init

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        run: |
          tofu plan -detailed-exitcode -out=tfplan || echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan
          retention-days: 5

  full-deploy:
    name: Full Deploy
    needs: [check, plan]
    runs-on: ubuntu-latest
    if: needs.check.outputs.deploy_mode == 'full' || needs.check.outputs.server_exists == 'false'
    environment: production
    outputs:
      server_ip: ${{ steps.server.outputs.ip }}
      firewall_id: ${{ steps.server.outputs.firewall_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TF_VERSION }}

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: terraform

      - name: Restore Terraform State
        uses: actions/cache/restore@v4
        with:
          path: |
            terraform/terraform.tfstate
            terraform/terraform.tfstate.backup
          key: terraform-state-${{ github.repository }}

      - name: Terraform Init
        working-directory: terraform
        run: tofu init

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Cleanup Existing Resources
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          echo "Full deploy: Deleting existing Hetzner resources..."
          hcloud server delete myclaw 2>/dev/null || true
          hcloud firewall delete myclaw 2>/dev/null || true
          hcloud ssh-key delete myclaw 2>/dev/null || true
          echo "Cleanup complete"

      - name: Terraform Apply
        working-directory: terraform
        run: tofu apply -auto-approve tfplan

      - name: Save Terraform State
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            terraform/terraform.tfstate
            terraform/terraform.tfstate.backup
          key: terraform-state-${{ github.repository }}

      - name: Get Server IP
        id: server
        working-directory: terraform
        run: |
          echo "ip=$(tofu output -raw server_ip)" >> $GITHUB_OUTPUT
          echo "ssh_command=$(tofu output -raw ssh_command)" >> $GITHUB_OUTPUT
          echo "firewall_id=$(tofu output -raw firewall_id)" >> $GITHUB_OUTPUT

      - name: Allow GitHub Runner SSH Access
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "GitHub Runner IP: $RUNNER_IP"
          hcloud firewall add-rule ${{ steps.server.outputs.firewall_id }} \
            --direction in \
            --protocol tcp \
            --port 22 \
            --source-ips "$RUNNER_IP/32" \
            --description "Temporary: GitHub Actions deployment"
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV

      - name: Wait for Server
        run: |
          echo "Waiting for server to be ready..."
          sleep 60
          for i in {1..30}; do
            if ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${{ steps.server.outputs.ip }} "echo 'Server ready'" 2>/dev/null; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $i/30 - Server not ready yet, waiting..."
            sleep 10
          done

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Inject SSH Key into NixOS Config
        run: |
          sed -i 's|openssh.authorizedKeys.keys = \[|openssh.authorizedKeys.keys = [ "'"${{ secrets.SSH_PUBLIC_KEY }}"'" |' nixos/configuration.nix

      - name: Install NixOS via nixos-anywhere
        run: |
          nix run github:nix-community/nixos-anywhere -- \
            --flake .#myclaw \
            --target-host root@${{ steps.server.outputs.ip }} \
            --ssh-option "IdentityFile=~/.ssh/id_ed25519" \
            --ssh-option "StrictHostKeyChecking=no" \
            --ssh-option "UserKnownHostsFile=/dev/null" \
            --ssh-option "ConnectTimeout=120" \
            --ssh-option "ServerAliveInterval=15" \
            --ssh-option "ServerAliveCountMax=20"
          ssh-keygen -R ${{ steps.server.outputs.ip }} 2>/dev/null || true

      - name: Wait for NixOS to Stabilize
        run: |
          echo "Waiting for NixOS to stabilize..."
          sleep 30
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"
          for i in {1..10}; do
            if ssh $SSH_OPTS root@${{ steps.server.outputs.ip }} "echo 'Server ready'" 2>/dev/null; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $i/10 - waiting..."
            sleep 10
          done

      - name: Build Application
        run: |
          npm ci
          npx tsc

      - name: Deploy Application
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ steps.server.outputs.ip }}"

          echo "Deploying application..."
          ssh $SSH_OPTS root@$SERVER_IP "mkdir -p /var/lib/myclaw/app/runtime/.claude"

          # Copy built application
          scp $SSH_OPTS -r dist root@$SERVER_IP:/var/lib/myclaw/app/
          scp $SSH_OPTS package.json package-lock.json root@$SERVER_IP:/var/lib/myclaw/app/
          scp $SSH_OPTS -r runtime root@$SERVER_IP:/var/lib/myclaw/app/

          # Install production dependencies (compiles native modules for Linux)
          echo "Installing production dependencies..."
          ssh $SSH_OPTS root@$SERVER_IP "cd /var/lib/myclaw/app && npm ci --production"

          # Install Claude Code CLI globally
          echo "Installing Claude Code CLI..."
          ssh $SSH_OPTS root@$SERVER_IP "npm install -g @anthropic-ai/claude-code"

          # Fix ownership
          ssh $SSH_OPTS root@$SERVER_IP "chown -R myclaw:myclaw /var/lib/myclaw/app"

      - name: Deploy Environment File
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ steps.server.outputs.ip }}"

          cat > /tmp/myclaw.env << ENVEOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ALLOWED_IDS=${{ secrets.TELEGRAM_ALLOWED_IDS }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET }}
          VAULT_PATH=/var/lib/myclaw/vault
          DB_PATH=/var/lib/myclaw/data/myclaw.db
          NODE_ENV=production
          ACTIVE_HOURS_START=08:00
          ACTIVE_HOURS_END=22:00
          ACTIVE_HOURS_TZ=Europe/Paris
          HEARTBEAT_INTERVAL_CRON=*/30 * * * *
          CLAUDE_MODEL=claude-sonnet-4-5-20250929
          HEARTBEAT_MODEL=claude-haiku-4-5-20251001
          ENVEOF

          scp $SSH_OPTS /tmp/myclaw.env root@$SERVER_IP:/var/lib/myclaw/.env
          ssh $SSH_OPTS root@$SERVER_IP "chown myclaw:myclaw /var/lib/myclaw/.env && chmod 600 /var/lib/myclaw/.env"
          rm -f /tmp/myclaw.env

      - name: Deploy rclone Config
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          SERVER_IP="${{ steps.server.outputs.ip }}"

          if [ -n "${{ secrets.RCLONE_CONFIG }}" ]; then
            echo "Deploying rclone configuration..."
            ssh $SSH_OPTS root@$SERVER_IP "mkdir -p /var/lib/myclaw/.config/rclone"
            printf '%s' "${{ secrets.RCLONE_CONFIG }}" > /tmp/rclone.conf
            scp $SSH_OPTS /tmp/rclone.conf root@$SERVER_IP:/var/lib/myclaw/.config/rclone/rclone.conf
            ssh $SSH_OPTS root@$SERVER_IP "chown -R myclaw:myclaw /var/lib/myclaw/.config && chmod 600 /var/lib/myclaw/.config/rclone/rclone.conf"
            rm -f /tmp/rclone.conf
          fi

      - name: Start MyClaw Service
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          ssh $SSH_OPTS root@${{ steps.server.outputs.ip }} "systemctl restart myclaw"
          echo "MyClaw service started"

      - name: Remove Temporary Firewall Rule
        if: always()
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          if [ -n "$RUNNER_IP" ]; then
            hcloud firewall delete-rule ${{ steps.server.outputs.firewall_id }} \
              --direction in \
              --protocol tcp \
              --port 22 \
              --source-ips "$RUNNER_IP/32" || true
          fi

      - name: Deploy Summary
        run: |
          echo "## Full Deploy Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server IP:** \`${{ steps.server.outputs.ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SSH:** \`${{ steps.server.outputs.ssh_command }}\`" >> $GITHUB_STEP_SUMMARY

  # Verify deployment
  verify:
    name: Verify Deployment
    needs: [check, quick-deploy, full-deploy]
    runs-on: ubuntu-latest
    if: always() && (needs.quick-deploy.result == 'success' || needs.full-deploy.result == 'success')
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Get Server Info
        id: server
        run: |
          if [ "${{ needs.quick-deploy.result }}" == "success" ]; then
            echo "ip=${{ needs.quick-deploy.outputs.server_ip }}" >> $GITHUB_OUTPUT
            echo "firewall_id=${{ needs.quick-deploy.outputs.firewall_id }}" >> $GITHUB_OUTPUT
          else
            echo "ip=${{ needs.full-deploy.outputs.server_ip }}" >> $GITHUB_OUTPUT
            echo "firewall_id=${{ needs.full-deploy.outputs.firewall_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Allow GitHub Runner SSH Access
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          hcloud firewall add-rule ${{ steps.server.outputs.firewall_id }} \
            --direction in \
            --protocol tcp \
            --port 22 \
            --source-ips "$RUNNER_IP/32" \
            --description "Temporary: GitHub Actions verify" || true
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV

      - name: Health Check
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${{ steps.server.outputs.ip }} << 'EOF'
            echo "=== System Health Check ==="
            echo "Hostname: $(hostname)"
            echo "Uptime: $(uptime)"
            echo "Memory: $(free -h | grep Mem)"
            echo "Disk: $(df -h / | tail -1)"
            echo ""
            echo "=== Services Status ==="
            systemctl is-active myclaw && echo "MyClaw: running" || echo "MyClaw: not running"
            echo ""
            echo "=== Timers ==="
            systemctl list-timers myclaw-* --no-pager 2>/dev/null || true
            echo ""
            echo "=== Recent Logs ==="
            journalctl -u myclaw --no-pager -n 10 2>/dev/null || true
          EOF

      - name: Remove Temporary Firewall Rule
        if: always()
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          if [ -n "$RUNNER_IP" ]; then
            hcloud firewall delete-rule ${{ steps.server.outputs.firewall_id }} \
              --direction in \
              --protocol tcp \
              --port 22 \
              --source-ips "$RUNNER_IP/32" || true
          fi
